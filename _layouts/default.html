<!DOCTYPE html>
<html lang="{{ site.lang }}">

<!-- Head -->

<head>
  {%- if page.redirect -%}
  <meta http-equiv="refresh" content="3; url={{ site.baseurl }}/" />
  {%- endif -%}
  {% include head.html %}
  <!-- Add this to <head> section for immediate theme toggle -->
  <script>
    (function () {
      'use strict';

      // Apply saved theme immediately (blocks rendering for instant apply)
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }

      // Set up toggle as soon as possible
      function setupToggle() {
        const toggle = document.getElementById('light-toggle');
        if (!toggle || toggle.dataset.setup) return;
        toggle.dataset.setup = 'true';

        toggle.addEventListener('click', function (e) {
          e.preventDefault();
          const html = document.documentElement;
          const current = html.getAttribute('data-theme') || 'light';
          const newTheme = current === 'dark' ? 'light' : 'dark';

          html.classList.add('transition');
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);

          setTimeout(() => html.classList.remove('transition'), 750);
        });
      }

      // Try multiple times to catch the toggle button
      let attempts = 0;
      const maxAttempts = 10;

      function trySetup() {
        setupToggle();
        if (!document.getElementById('light-toggle') && attempts < maxAttempts) {
          attempts++;
          setTimeout(trySetup, 50);
        }
      }

      // Start trying immediately
      trySetup();

      // Also try on standard events
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupToggle);
        document.addEventListener('readystatechange', function () {
          if (document.readyState === 'interactive') setupToggle();
        });
      }

      // Watch for toggle being added
      if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver(function (mutations) {
          setupToggle();
        });

        // Start observing as soon as possible
        if (document.documentElement) {
          observer.observe(document.documentElement, {
            childList: true,
            subtree: true
          });
        }
      }
    })();
  </script>
</head>

<!-- Body -->

<body
  class="{% if site.navbar_fixed %}fixed-top-nav{% endif %} {% unless site.footer_fixed %}sticky-bottom-footer{% endunless %}">

  <!-- Header -->
  {%- include header.html %}

  <!-- Content -->
  <div class="container mt-5">
    {% if page.toc and page.toc.sidebar %}
    {% if page.toc.sidebar == "right" %}
    <div class="row">
      <!-- main content area -->
      <div class="col-sm-9">
        {{ content }}
      </div>
      <!-- sidebar, which will move to the top on a small screen -->
      <div class="col-sm-3">
        <nav id="toc-sidebar" class="sticky-top"></nav>
      </div>
    </div>
    {% else %}
    <div class="row">
      <!-- sidebar, which will move to the top on a small screen -->
      <div class="col-sm-3">
        <nav id="toc-sidebar" class="sticky-top"></nav>
      </div>
      <!-- main content area -->
      <div class="col-sm-9">
        {{ content }}
      </div>
    </div>
    {% endif %}
    {% else %}
    {{ content }}
    {% endif %}
  </div>

  <!-- Footer -->
  {%- include footer.html %}

  <!-- JavaScripts -->
  {% include scripts/jquery.html %}
  {% include scripts/bootstrap.html %}
  {% include scripts/masonry.html %}
  {% include scripts/misc.html %}
  {% include scripts/badges.html %}
  {% include scripts/mathjax.html %}
  {% include scripts/analytics.html %}
  {% include scripts/progressBar.html %}
  {% include scripts/wechatModal.html %}
  <!-- <script src="{{ '/assets/js/publications-expand.js' | relative_url }}" defer></script> -->

</body>

</html>